name: CI

on:
  pull_request:
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/ci.yml'
      - 'package.json'
      - 'bun.lockb'
  push:
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/ci.yml'
      - 'package.json'
      - 'bun.lockb'
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install root deps
        run: bun install --ignore-scripts
      
      - name: Install workspaces deps
        run: |
          cd frontend && bun install --ignore-scripts && cd ..
          cd backend && bun install --ignore-scripts && cd ..
      
      - name: Generate Prisma Client
        run: bun run --cwd backend prisma:generate
      
      - name: Setup environment files
        env:
          GITHUB_TOKEN: ${{ secrets.ENV_REPO_PAT }}
          ENV_REPO_URL: https://x-access-token:${{ secrets.ENV_REPO_PAT }}@github.com/CodeGachi/.env.git
        run: |
          bun run env:sync || {
            echo "‚ùå Environment sync failed"
            echo "üìã Check if ENV_REPO_PAT secret has correct permissions:"
            echo "   - repo (Full control of private repositories)"
            echo "   - CodeGachi/.env repository must exist with dev branch"
            exit 1
          }
          echo "‚úÖ Environment files synced"
          cp .env.dev .env

      - name: Test
        run: |
          bun run --cwd frontend test:ci
          bun run --cwd backend test:ci

      - name: Lint
        run: |
          bun run --cwd frontend lint
          bun run --cwd backend lint

      - name: Build
        run: |
          NODE_ENV=production bun run --cwd frontend build
          NODE_ENV=production bun run --cwd backend build
